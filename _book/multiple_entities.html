<!DOCTYPE HTML>
<html lang="en" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Multiple entities | express-saml2</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.4.3">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="gitbook/style.css">
    
        
        <link rel="stylesheet" href="gitbook/plugins/gitbook-plugin-highlight/website.css">
        
    
    

        
    
    
    <link rel="next" href="./metadata_distribution.html" />
    
    
    <link rel="prev" href="./custom_templates.html" />
    

        
    </head>
    <body>
        
        
    <div class="book" data-level="2.3" data-basepath="." data-revision="Tue Oct 27 2015 16:06:16 GMT+0800 (HKT)">
    

<div class="book-summary">
    <div class="book-search" role="search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <nav role="navigation">
        <ul class="summary">
            
            
            
            

            

            
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="./index.html">
                
                        <i class="fa fa-check"></i>
                        
                        Home
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" data-path="basics.html">
            
                
                    <a href="./basics.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        Basics
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1" data-path="knowledge.html">
            
                
                    <a href="./knowledge.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                        Knowledge
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="basic_identity_provider.html">
            
                
                    <a href="./basic_identity_provider.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                        Identity Provider
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="basic_service_provider.html">
            
                
                    <a href="./basic_service_provider.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.3.</b>
                        
                        Service Provider
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="send_a_saml_request.html">
            
                
                    <a href="./send_a_saml_request.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.3.1.</b>
                        
                        SAML Request
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="signed_saml_request.html">
            
                
                    <a href="./signed_saml_request.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.3.2.</b>
                        
                        Signed SAML Request
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="receive_a_saml_response.html">
            
                
                    <a href="./receive_a_saml_response.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.3.3.</b>
                        
                        SAML Response
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="signed_saml_response.html">
            
                
                    <a href="./signed_saml_response.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.3.4.</b>
                        
                        Signed SAML Response
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="encrypted_assertion.html">
            
                
                    <a href="./encrypted_assertion.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.3.5.</b>
                        
                        Encrypted SAML Response
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="work_examples.html">
            
                
                    <a href="./work_examples.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.4.</b>
                        
                        Work with OneLogin
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2" data-path="advanced.html">
            
                
                    <a href="./advanced.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        Advanced
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1" data-path="configuration_without_metadata.html">
            
                
                    <a href="./configuration_without_metadata.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.</b>
                        
                        Configuration without metadata
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="custom_templates.html">
            
                
                    <a href="./custom_templates.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.2.</b>
                        
                        Custom templates
                    </a>
            
            
        </li>
    
        <li class="chapter active" data-level="2.3" data-path="multiple_entities.html">
            
                
                    <a href="./multiple_entities.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.3.</b>
                        
                        Multiple entities
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="metadata_distribution.html">
            
                
                    <a href="./metadata_distribution.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.4.</b>
                        
                        Metadata distribution
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    


            
            <li class="divider"></li>
            <li>
                <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                    Published with GitBook
                </a>
            </li>
            
        </ul>
    </nav>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Table of Contents"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Font Settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Share"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">
                    Share on Twitter
                </button>
                <button type="button" data-sharing="google-plus" class="button">
                    Share on Google
                </button>
                <button type="button" data-sharing="facebook" class="button">
                    Share on Facebook
                </button>
                <button type="button" data-sharing="weibo" class="button">
                    Share on Weibo
                </button>
                <button type="button" data-sharing="instapaper" class="button">
                    Share on Instapaper
                </button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Google"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Twitter"><i class="fa fa-twitter"></i></a>
    
    
    


    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="./" >express-saml2</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <h1 id="multiple-entities">Multiple entities</h1>
<p>For those applications with many clients, each client may have its own Identity Provider. Developers just need to configure multiple IdPs. Different configuration of SP is required for different IdP, therefore multiple SPs are allowed.</p>
<p><strong>Multiple IdPs - Single SP</strong></p>
<pre><code class="lang-javascript"><span class="hljs-comment">// Define SP</span>
<span class="hljs-keyword">var</span> sp = saml.ServiceProvider(<span class="hljs-string">&apos;./metadata_sp.xml&apos;</span>);
<span class="hljs-comment">// Define multiple IdPs</span>
<span class="hljs-keyword">var</span> defaultIdP = saml.IdentityProvider(<span class="hljs-string">&apos;./metadata_idp_default.xml&apos;</span>);
<span class="hljs-keyword">var</span> oneLoginIdP = saml.IdentityProvider(<span class="hljs-string">&apos;./metadata_onelogin.xml&apos;</span>);
<span class="hljs-comment">// URL routing for SP-initiated SSO </span>
router.get(<span class="hljs-string">&apos;/spinitsso-post/:idp&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{
    <span class="hljs-keyword">var</span> toIdP;
    <span class="hljs-keyword">switch</span>(req.params.idp || <span class="hljs-string">&apos;&apos;</span>) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;onelogin&apos;</span>: {
            toIdP = oneLoginIdP;
            <span class="hljs-keyword">break</span>;
        }
        <span class="hljs-keyword">default</span>: {
            toIdP = idp;
            <span class="hljs-keyword">break</span>;
        }
    }
    sp.sendLoginRequest(toIdP, <span class="hljs-string">&apos;post&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request</span>) </span>{
        res.render(<span class="hljs-string">&apos;actions&apos;</span>, request);
    });
});
</code></pre>
<p>Using the same SP configuration, it can apply to different IdPs. We&apos;ve played a trick here, the initiated URL for SP-inititated SSO is controlled by a parameter. When user accesses <code>/spinitsso-post/onelogin</code>, the OneLogin IdP is used. When user accesses <code>/spinitsso-post/default</code>, the default IdP is then used for authentication.</p>
<p><strong>Multiple IdPs - Mutiple SPs</strong></p>
<p>Different IdPs may have different preference, so single SP configuration may not be suitable. For example, OneLogin IdP requires a request with signature but our default IdP does not. Here we come up with another solution which is very similar to the previous one.</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// Define a default SP</span>
<span class="hljs-keyword">var</span> spForDefault = saml.ServiceProvider(<span class="hljs-string">&apos;./metadata_sp.xml&apos;</span>);
<span class="hljs-comment">// Define SP for OneLogin with different metadta</span>
<span class="hljs-keyword">var</span> spForOnelogin = saml.ServiceProvider(<span class="hljs-string">&apos;./metadata_sp_for_oneLogin.xml&apos;</span>);
<span class="hljs-comment">// Define a default IdP</span>
<span class="hljs-keyword">var</span> defaultIdP = saml.IdentityProvider(<span class="hljs-string">&apos;./metadata_idp_default.xml&apos;</span>);
<span class="hljs-comment">// Define OneLogin IdP</span>
<span class="hljs-keyword">var</span> oneLoginIdP = saml.IdentityProvider(<span class="hljs-string">&apos;./metadata_onelogin.xml&apos;</span>);
<span class="hljs-comment">// URL routing for SP-initiated SSO </span>
router.get(<span class="hljs-string">&apos;/spinitsso-post/:idp&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{
    <span class="hljs-keyword">var</span> toIdP, fromSP;
    <span class="hljs-keyword">switch</span>(req.params.idp || <span class="hljs-string">&apos;&apos;</span>) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;onelogin&apos;</span>: {
            toIdP = oneLoginIdP;
            fromSP = spForOnelogin;
            <span class="hljs-keyword">break</span>;
        }
        <span class="hljs-keyword">default</span>: {
            toIdP = idp;
            fromSP = spForDefault;
            <span class="hljs-keyword">break</span>;
        }
    }
    fromSP.sendLoginRequest(toIdP, <span class="hljs-string">&apos;post&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request</span>) </span>{
        res.render(<span class="hljs-string">&apos;actions&apos;</span>, request);
    });
});
</code></pre>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="./custom_templates.html" class="navigation navigation-prev " aria-label="Previous page: Custom templates"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="./metadata_distribution.html" class="navigation navigation-next " aria-label="Next page: Metadata distribution"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="gitbook/app.js"></script>

    
    <script src="gitbook/plugins/gitbook-plugin-livereload/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
